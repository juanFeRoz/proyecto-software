<!DOCTYPE html>
<html>
<head>
    <title>Spring Chat App</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        #connect-btn, #disconnect-btn, #send-btn { margin: 5px; }
        #chat-ui, #logout-section { display: none; }
        .form-section { margin-bottom: 20px; }
    </style>
</head>
<body>
<h2>Spring WebSocket Group Chat</h2>

<!-- Login/Register Section -->
<div id="auth-section">
    <!-- Register Form -->
    <div class="form-section">
        <h3>Register</h3>
        <form id="form-register">
            <input type="text" name="username" placeholder="Username" required />
            <input type="password" name="password" placeholder="Password" required />
            <button type="submit">Register</button>
        </form>
        <p id="register-error" style="color: red;"></p>
        <p id="register-success" style="color: green;"></p>
    </div>

    <!-- Login Form -->
    <div class="form-section">
        <h3>Login</h3>
        <form id="form-login">
            <input type="text" name="username" placeholder="Username" required />
            <input type="password" name="password" placeholder="Password" required />
            <button type="submit">Login</button>
        </form>
        <p id="login-error" style="color: red;"></p>
    </div>
</div>

<!-- Logout -->
<div id="logout-section">
    <button id="logout-btn">Logout</button>
</div>

<!-- Chat UI -->
<div id="chat-ui">
    <div>
        <button id="connect-btn">Connect</button>
        <button id="disconnect-btn" disabled>Disconnect</button>
    </div>

    <div id="messages"></div>

    <input type="text" id="message-input" placeholder="Type a message..." />
    <button id="send-btn">Send</button>
</div>

<script>
    let stompClient = null;

    document.getElementById('form-register').addEventListener('submit', async function (e) {
        e.preventDefault();
        const form = new FormData(e.target);
        const body = Object.fromEntries(form.entries());

        const res = await fetch('/api/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if (res.ok) {
            document.getElementById('register-error').innerText = '';
            document.getElementById('register-success').innerText = 'Registration successful. You can now log in.';
            e.target.reset();
        } else {
            const errorText = await res.text();
            document.getElementById('register-error').innerText = errorText || 'Registration failed';
            document.getElementById('register-success').innerText = '';
        }
    });

    document.getElementById('form-login').addEventListener('submit', async function (e) {
        e.preventDefault();
        const form = new FormData(e.target);
        const body = new URLSearchParams(form);

        const res = await fetch('/api/auth/login', {
            method: 'POST',
            body,
            credentials: 'include' // this is essential to enable session
        });

        if (res.ok) {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('logout-section').style.display = 'block';
            document.getElementById('chat-ui').style.display = 'block';
            document.getElementById('login-error').innerText = '';
        } else {
            document.getElementById('login-error').innerText = 'Login failed';
        }
    });

    document.getElementById('logout-btn').addEventListener('click', async () => {
        await fetch('/api/auth/logout', {
            method: 'POST',
            credentials: 'include'
        });

        document.getElementById('auth-section').style.display = 'block';
        document.getElementById('logout-section').style.display = 'none';
        document.getElementById('chat-ui').style.display = 'none';
        disconnect();
    });

    function connect() {
        const socket = new SockJS('/ws-chat');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, (frame) => {
            console.log('Connected: ' + frame);
            document.getElementById('connect-btn').disabled = true;
            document.getElementById('disconnect-btn').disabled = false;

            stompClient.subscribe('/topic/public', (message) => {
                const msg = JSON.parse(message.body);
                showMessage(`${msg.timestamp} - ${msg.sender}: ${msg.content}`);
            });
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        document.getElementById('connect-btn').disabled = false;
        document.getElementById('disconnect-btn').disabled = true;
    }

    function sendMessage() {
        const content = document.getElementById('message-input').value.trim();
        if (content && stompClient) {
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify({ content }));
            document.getElementById('message-input').value = '';
        }
    }

    function showMessage(message) {
        const messagesDiv = document.getElementById('messages');
        const p = document.createElement('p');
        p.textContent = message;
        messagesDiv.appendChild(p);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    document.getElementById('connect-btn').addEventListener('click', connect);
    document.getElementById('disconnect-btn').addEventListener('click', disconnect);
    document.getElementById('send-btn').addEventListener('click', sendMessage);
</script>
</body>
</html>